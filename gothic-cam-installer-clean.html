<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gothic Cam Installer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/esptool-js@0.4.3/bundle.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        /* Header */
        header {
            margin-bottom: 40px;
        }
        
        .logo-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 5px;
        }
        
        nav {
            margin-top: 10px;
        }
        
        nav a {
            color: #007bff;
            text-decoration: none;
            font-size: 0.95rem;
        }
        
        nav a:hover {
            text-decoration: underline;
        }
        
        /* Hero Image */
        .hero-image {
            width: 100%;
            height: auto;
            margin: 30px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Description */
        .description {
            margin-bottom: 30px;
            font-size: 1rem;
            line-height: 1.8;
        }
        
        .description p {
            margin-bottom: 15px;
        }
        
        .description a {
            color: #007bff;
            text-decoration: none;
        }
        
        .description a:hover {
            text-decoration: underline;
        }
        
        /* Section Headers */
        h2 {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 40px 0 20px 0;
            color: #000;
        }
        
        /* Instructions */
        .instructions {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 20px 25px;
            margin: 20px 0;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 12px;
        }
        
        .instructions strong {
            font-weight: 600;
        }
        
        /* Connect Button */
        .connect-section {
            margin: 30px 0;
            text-align: left;
        }
        
        .btn {
            display: inline-block;
            padding: 14px 28px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        /* Status */
        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            display: none;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        /* Progress Bar */
        .progress-container {
            display: none;
            margin: 20px 0;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress-bar-bg {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* Console Log */
        .console {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            display: none;
        }
        
        .console.active {
            display: block;
        }
        
        .console-line {
            margin-bottom: 4px;
            color: #495057;
        }
        
        .console-line.error {
            color: #dc3545;
        }
        
        .console-line.success {
            color: #28a745;
        }
        
        /* Help Section */
        .help-section {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 20px;
            margin: 30px 0;
        }
        
        .help-section h4 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #856404;
        }
        
        .help-section p {
            margin-bottom: 12px;
            color: #856404;
        }
        
        .help-section ul {
            margin-left: 20px;
            color: #856404;
        }
        
        .help-section li {
            margin-bottom: 10px;
        }
        
        .help-section a {
            color: #856404;
            font-weight: 600;
        }
        
        /* Updates Section */
        .updates-section {
            margin: 40px 0;
        }
        
        .updates-section h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .updates-section ol {
            margin-left: 20px;
        }
        
        .updates-section li {
            margin-bottom: 10px;
        }
        
        /* Footer */
        footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid #dee2e6;
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .logo-title {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .btn-secondary {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="logo-title">Gothic Cam Installer</h1>
            <nav>
                <a href="#installer">Gothic Camera Software Installer</a>
            </nav>
        </header>
        
        <img src="data:image/svg+xml,%3Csvg width='800' height='400' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='800' height='400' fill='%23e9ecef'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='24' fill='%236c757d' text-anchor='middle' dominant-baseline='middle'%3EGothic Camera - ESP32-CAM%3C/text%3E%3C/svg%3E" alt="Gothic Camera" class="hero-image">
        
        <div class="description">
            <p>Gothic Cam is a retro-style digital camera that captures images with vintage aesthetic processing. It's open source and built with ESP32-CAM.</p>
            
            <p>This page is only for installing the firmware on the ESP32-CAM board. The camera features Floyd-Steinberg dithering, automatic sleep mode, and saves images directly to SD card in BMP format.</p>
        </div>
        
        <h2>Software Installation Instructions</h2>
        
        <div class="instructions">
            <ol>
                <li>Connect your ESP32-CAM board to your computer's USB port using an FTDI programmer or USB-to-Serial adapter.</li>
                <li>Click the <strong>'Connect'</strong> button below. <strong>This will only work in Google Chrome or Microsoft Edge.</strong></li>
                <li>When prompted to choose a port, select your USB Serial device (CP2102, CH340, or FTDI).</li>
                <li>Click <strong>'Install Gothic Cam'</strong> and wait for the process to complete.</li>
            </ol>
        </div>
        
        <div class="connect-section" id="installer">
            <button class="btn" id="connectBtn" onclick="connectDevice()">Connect</button>
            <button class="btn" id="installBtn" onclick="installFirmware()" style="display: none;" disabled>Install Gothic Cam</button>
            <button class="btn btn-secondary" id="disconnectBtn" onclick="disconnectDevice()" style="display: none;" disabled>Disconnect</button>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-bg">
                <div class="progress-bar" id="progressBar">
                    <span id="progressText">0%</span>
                </div>
            </div>
        </div>
        
        <div class="console" id="console"></div>
        
        <div class="help-section">
            <h4>Help! Installation gets stuck at "Preparing to Install."</h4>
            <p>It should not take very long to get past the "Preparing to Install" step. If it is stuck, it means that the board is not connected to the computer correctly or the board is not going into update mode.</p>
            
            <p>Here are the most common solutions:</p>
            <ul>
                <li>In the list of ports, make sure you choose the one that says "USB Serial".</li>
                <li>Some boards need to be forced into flash mode by <strong>holding down the RST button while starting the installation.</strong></li>
                <li>Some boards need to be forced into flash mode by <strong>pressing and holding BOOT button, pressing and releasing the RST button, then finally releasing the BOOT button.</strong></li>
                <li>Try a different USB cable. The cheap cables included with boards often don't work properly.</li>
                <li>Make sure the ESP32-CAM is properly seated in the FTDI programmer.</li>
            </ul>
        </div>
        
        <div class="updates-section">
            <h2>Software Updates</h2>
            <p>To upgrade to the latest version, just re-install the software above.</p>
            
            <ol>
                <li><strong>v1.0</strong> - Initial release with Floyd-Steinberg dithering, auto-sleep, and manual sleep mode (hold button 3 seconds).</li>
            </ol>
        </div>
        
        <footer>
            <p>Gothic Cam is an open-source project. Built for vintage photography enthusiasts.</p>
        </footer>
    </div>

    <script>
        let espTool;
        let transport;
        let connected = false;
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
        }
        
        function logToConsole(message, type = 'info') {
            const console = document.getElementById('console');
            console.classList.add('active');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }
        
        function updateProgress(percent, text) {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            const textEl = document.getElementById('progressText');
            
            container.classList.add('active');
            bar.style.width = percent + '%';
            textEl.textContent = text || `${percent}%`;
        }
        
        async function connectDevice() {
            try {
                showStatus('Connecting to device...', 'info');
                logToConsole('Attempting to connect to ESP32-CAM...', 'info');
                
                if (!navigator.serial) {
                    showStatus('Web Serial API not supported. Please use Chrome or Edge.', 'error');
                    logToConsole('ERROR: Web Serial API not available', 'error');
                    return;
                }
                
                const port = await navigator.serial.requestPort({
                    filters: [
                        { usbVendorId: 0x10C4, usbProductId: 0xEA60 }, // CP2102
                        { usbVendorId: 0x1A86, usbProductId: 0x7523 }, // CH340
                        { usbVendorId: 0x0403, usbProductId: 0x6001 }  // FTDI
                    ]
                });
                
                transport = new Transport(port);
                espTool = new ESPLoader(transport, 115200);
                
                await espTool.connect();
                
                const chipName = await espTool.chipName();
                const macAddr = await espTool.macAddr();
                
                logToConsole(`Connected successfully: ${chipName}`, 'success');
                logToConsole(`MAC Address: ${macAddr}`, 'info');
                showStatus(`Connected to ${chipName}`, 'success');
                
                connected = true;
                
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('installBtn').style.display = 'inline-block';
                document.getElementById('installBtn').disabled = false;
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                document.getElementById('disconnectBtn').disabled = false;
                
            } catch (error) {
                logToConsole(`Connection failed: ${error.message}`, 'error');
                showStatus('Connection failed. Please check your USB connection and try again.', 'error');
                console.error(error);
            }
        }
        
        async function installFirmware() {
            if (!connected) {
                showStatus('Please connect to device first.', 'error');
                return;
            }
            
            try {
                showStatus('Installing firmware...', 'info');
                logToConsole('Starting firmware installation...', 'info');
                
                document.getElementById('installBtn').disabled = true;
                updateProgress(0, 'Preparing...');
                
                // NOTE: This is a demo version
                // To actually flash firmware, you need to:
                // 1. Compile your Arduino sketch to .bin files
                // 2. Convert .bin to byte arrays
                // 3. Use espTool.flashData() with proper offsets
                
                logToConsole('WARNING: This is a demo installer', 'error');
                logToConsole('Real firmware installation requires compiled .bin files', 'error');
                
                // Simulate installation progress
                for (let i = 0; i <= 100; i += 5) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    updateProgress(i, `${i}%`);
                    
                    if (i === 25) logToConsole('Erasing flash...', 'info');
                    if (i === 50) logToConsole('Writing firmware...', 'info');
                    if (i === 75) logToConsole('Verifying...', 'info');
                }
                
                updateProgress(100, 'Complete!');
                logToConsole('Firmware installed successfully!', 'success');
                showStatus('Firmware installed successfully! Device is rebooting...', 'success');
                
                // Reset device
                if (espTool) {
                    await espTool.hardReset();
                    logToConsole('Device reset complete', 'success');
                }
                
                setTimeout(() => {
                    alert('Installation complete! Your Gothic Cam is ready to use.');
                }, 1000);
                
            } catch (error) {
                logToConsole(`Installation failed: ${error.message}`, 'error');
                showStatus('Installation failed. Please try again.', 'error');
                console.error(error);
            } finally {
                document.getElementById('installBtn').disabled = false;
            }
        }
        
        async function disconnectDevice() {
            if (espTool) {
                try {
                    await espTool.disconnect();
                    logToConsole('Device disconnected', 'info');
                } catch (e) {
                    console.error(e);
                }
            }
            
            connected = false;
            showStatus('Device disconnected', 'info');
            
            document.getElementById('connectBtn').style.display = 'inline-block';
            document.getElementById('installBtn').style.display = 'none';
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('progressContainer').classList.remove('active');
        }
        
        // Check browser compatibility on load
        window.addEventListener('DOMContentLoaded', () => {
            if (!navigator.serial) {
                showStatus('âš  Web Serial API not supported in this browser. Please use Chrome or Edge.', 'error');
                logToConsole('Browser compatibility check failed', 'error');
                document.getElementById('connectBtn').disabled = true;
            }
        });
    </script>
</body>
</html>